name: Build and Notify

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run your build
        run: |
          echo "ðŸ› ï¸ Building..."
          # Replace this with your actual build logic
          echo "âœ… Build done"

      - name: Get pull request info
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
            });

            if (prs.data.length === 0) {
              core.setOutput("found", "false");
            } else {
              const pr = prs.data[0];
              core.setOutput("found", "true");
              core.setOutput("title", pr.title);
              core.setOutput("body", pr.body || "");
              core.setOutput("url", pr.html_url);
            }

      - name: Extract Linear link
        id: linear
        if: steps.pr.outputs.found == 'true'
        run: |
          TEXT="${{ steps.pr.outputs.title }} ${{ steps.pr.outputs.body }}"
          echo "Scanning PR for Linear link..."
          LINEAR_LINK=$(echo "$TEXT" | grep -Eo 'https://linear\.app/[^\s)]+')
          echo "Found Linear link: $LINEAR_LINK"
          echo "link=$LINEAR_LINK" >> $GITHUB_OUTPUT

      - name: Send Telegram message
        if: steps.linear.outputs.link != ''
        run: |
          MESSAGE="âœ… Build succeeded!\nðŸ”— [View Linear Issue](${{ steps.linear.outputs.link }})"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MESSAGE" \
            -d parse_mode=Markdown